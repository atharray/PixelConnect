(function(){"use strict";function Y(e){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:{r:0,g:0,b:0}}function D(e){let t=e.r/255,o=e.g/255,s=e.b/255;return t=t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92,o=o>.04045?Math.pow((o+.055)/1.055,2.4):o/12.92,s=s>.04045?Math.pow((s+.055)/1.055,2.4):s/12.92,t*=100,o*=100,s*=100,{x:t*.4124+o*.3576+s*.1805,y:t*.2126+o*.7152+s*.0722,z:t*.0193+o*.1192+s*.9505}}function H(e){let t=e.x/95.047,o=e.y/100,s=e.z/108.883;return t=t>.008856?Math.pow(t,1/3):7.787*t+16/116,o=o>.008856?Math.pow(o,1/3):7.787*o+16/116,s=s>.008856?Math.pow(s,1/3):7.787*s+16/116,{l:116*o-16,a:500*(t-o),b:200*(o-s)}}function E(e){return H(D(e))}function S(e,t){const o=e.l-t.l,s=e.a-t.a,r=e.b-t.b;return Math.sqrt(o*o+s*s+r*r)}function _(e,t,o){const s=e.data,r=new ImageData(t,o),h=r.data,m=e.width/t,x=e.height/o;for(let d=0;d<o;d++)for(let u=0;u<t;u++){const g=Math.floor(u*m),i=(Math.floor(d*x)*e.width+g)*4,c=(d*t+u)*4;h[c]=s[i],h[c+1]=s[i+1],h[c+2]=s[i+2],h[c+3]=s[i+3]}return r}function k(e,t,o){const s=e.data,r=new ImageData(t,o),h=r.data,m=(e.width-1)/t,x=(e.height-1)/o;for(let d=0;d<o;d++)for(let u=0;u<t;u++){const g=u*m,n=d*x,i=Math.floor(g),c=Math.floor(n),a=Math.min(i+1,e.width-1),f=Math.min(c+1,e.height-1),l=g-i,y=n-c,p=(d*t+u)*4;for(let w=0;w<4;w++){const I=s[(c*e.width+i)*4+w],b=s[(c*e.width+a)*4+w],z=s[(f*e.width+i)*4+w],M=s[(f*e.width+a)*4+w],R=I*(1-l)+b*l,v=z*(1-l)+M*l,C=R*(1-y)+v*y;h[p+w]=Math.round(C)}}return r}function F(e,t,o){const s=e.data,r=e.width,h=e.height,m=new ImageData(t,o),x=m.data,d=c=>{if(c=Math.abs(c),c===0)return 1;const a=Math.PI*c;return Math.sin(a)/a},u=(c,a)=>c>-a&&c<a?d(c)*d(c/a):0,g=r/t,n=h/o,i=3;for(let c=0;c<o;c++)for(let a=0;a<t;a++){const f=(c+.5)*n-.5,l=(a+.5)*g-.5;let y=0,p=0,w=0,I=0,b=0;const z=Math.floor(l)-i+1,M=Math.floor(l)+i,R=Math.floor(f)-i+1,v=Math.floor(f)+i;for(let A=R;A<=v;A++)if(!(A<0||A>=h))for(let L=z;L<=M;L++){if(L<0||L>=r)continue;const B=u(l-L,i)*u(f-A,i);if(B===0)continue;const X=(A*r+L)*4;y+=s[X]*B,p+=s[X+1]*B,w+=s[X+2]*B,I+=s[X+3]*B,b+=B}const C=(c*t+a)*4;b>0?(x[C]=y/b,x[C+1]=p/b,x[C+2]=w/b,x[C+3]=I/b):(x[C]=0,x[C+1]=0,x[C+2]=0,x[C+3]=0)}return m}const G={"bayer-4x4":{matrix:[[0,8,2,10],[12,4,14,6],[3,11,1,9],[15,7,13,5]],size:4,divisor:16},"bayer-8x8":{matrix:[[0,32,8,40,2,34,10,42],[48,16,56,24,50,18,58,26],[12,44,4,36,14,46,6,38],[60,28,52,20,62,30,54,22],[3,35,11,43,1,33,9,41],[51,19,59,27,49,17,57,25],[15,47,7,39,13,45,5,37],[63,31,55,23,61,29,53,21]],size:8,divisor:64},"halftone-dot":{matrix:[[12,5,6,13],[4,0,1,7],[8,2,3,11],[14,9,10,15]],size:4,divisor:16},"diagonal-line":{matrix:[[15,7,3,7],[7,3,7,15],[3,7,15,7],[7,15,7,3]],size:4,divisor:16},"cross-hatch":{matrix:[[0,8,0,8],[8,15,8,15],[0,8,0,8],[8,15,8,15]],size:4,divisor:16},grid:{matrix:[[0,0,0,0],[0,15,15,0],[0,15,15,0],[0,0,0,0]],size:4,divisor:16}},K={"floyd-steinberg":[{dx:1,dy:0,f:7/16},{dx:-1,dy:1,f:3/16},{dx:0,dy:1,f:5/16},{dx:1,dy:1,f:1/16}],burkes:[{dx:1,dy:0,f:8/32},{dx:2,dy:0,f:4/32},{dx:-2,dy:1,f:2/32},{dx:-1,dy:1,f:4/32},{dx:0,dy:1,f:8/32},{dx:1,dy:1,f:4/32},{dx:2,dy:1,f:2/32}],stucki:[{dx:1,dy:0,f:8/42},{dx:2,dy:0,f:4/42},{dx:-2,dy:1,f:2/42},{dx:-1,dy:1,f:4/42},{dx:0,dy:1,f:8/42},{dx:1,dy:1,f:4/42},{dx:2,dy:1,f:2/42},{dx:-2,dy:2,f:1/42},{dx:-1,dy:2,f:2/42},{dx:0,dy:2,f:4/42},{dx:1,dy:2,f:2/42},{dx:2,dy:2,f:1/42}],"sierra-2":[{dx:1,dy:0,f:4/16},{dx:2,dy:0,f:3/16},{dx:-2,dy:1,f:1/16},{dx:-1,dy:1,f:2/16},{dx:0,dy:1,f:3/16},{dx:1,dy:1,f:2/16},{dx:2,dy:1,f:1/16}],"sierra-lite":[{dx:1,dy:0,f:2/4},{dx:-1,dy:1,f:1/4},{dx:0,dy:1,f:1/4}]};function T(e,t,o){const s=E(e);let r=1/0,h=t[0];for(let m=0;m<t.length;m++){const x=S(s,o[m]);x<r&&(r=x,h=t[m])}return h}function U(e,t,o,s){const r=e.data,h=e.width,m=e.height,x=t.map(Y),d=x.map(E),u=s/100;if(o in G){const g=G[o],n=g.matrix,i=g.size,c=g.divisor,a=64;for(let f=0;f<m;f++)for(let l=0;l<h;l++){const y=(f*h+l)*4;if(r[y+3]<128){r[y+3]=0;continue}const p=l%i,w=f%i,b=(n[w][p]/c-.5)*a*u,z={r:Math.max(0,Math.min(255,r[y]+b)),g:Math.max(0,Math.min(255,r[y+1]+b)),b:Math.max(0,Math.min(255,r[y+2]+b))},M=T(z,x,d);r[y]=M.r,r[y+1]=M.g,r[y+2]=M.b,r[y+3]=255}}else{const g=new Float32Array(r),n=K[o];for(let i=0;i<m;i++)for(let c=0;c<h;c++){const a=(i*h+c)*4;if(g[a+3]<128){r[a+3]=0;continue}const f={r:g[a],g:g[a+1],b:g[a+2]},l=T(f,x,d);if(r[a]=l.r,r[a+1]=l.g,r[a+2]=l.b,r[a+3]=255,o==="none"||!n)continue;const y={r:(f.r-l.r)*u,g:(f.g-l.g)*u,b:(f.b-l.b)*u};for(const p of n){const w=c+p.dx,I=i+p.dy;if(w>=0&&w<h&&I>=0&&I<m){const b=(I*h+w)*4;if(g[b+3]<128)continue;g[b]+=y.r*p.f,g[b+1]+=y.g*p.f,g[b+2]+=y.b*p.f}}}}}function P(e,t,o=20){return new Promise(s=>{if(t>e.length&&(t=e.length),t===0){s({centroids:[],assignments:[]});return}let r=[];const h=[...e];for(let x=0;x<t;x++){const d=Math.floor(Math.random()*h.length);r.push(h.splice(d,1)[0])}let m=new Array(e.length);for(let x=0;x<o;x++){for(let n=0;n<e.length;n++){let i=1/0,c=-1;for(let a=0;a<t;a++){const f=(e[n][0]-r[a][0])**2+(e[n][1]-r[a][1])**2+(e[n][2]-r[a][2])**2;f<i&&(i=f,c=a)}m[n]=c}const d=Array.from({length:t},()=>[0,0,0]),u=new Array(t).fill(0);for(let n=0;n<e.length;n++){const i=m[n];d[i][0]+=e[n][0],d[i][1]+=e[n][1],d[i][2]+=e[n][2],u[i]++}for(let n=0;n<t;n++)u[n]>0?(d[n][0]/=u[n],d[n][1]/=u[n],d[n][2]/=u[n]):d[n]=e[Math.floor(Math.random()*e.length)];let g=!1;for(let n=0;n<t;n++)if(r[n][0]!==d[n][0]||r[n][1]!==d[n][1]||r[n][2]!==d[n][2]){g=!0;break}if(r=d,!g)break}s({centroids:r,assignments:m})})}function W(e){const t=o=>{const s=Math.round(o).toString(16);return s.length===1?"0"+s:s};return`#${t(e.r)}${t(e.g)}${t(e.b)}`.toUpperCase()}async function $(e,t,o){if(t.length===0)return[];const r=t.map(Y).map(E),h=e.data,m=[],x=h.length/4,u=Math.ceil(x/4096)*4;for(let l=0;l<h.length;l+=u)h[l+3]>128&&m.push([h[l],h[l+1],h[l+2]]);if(m.length===0)return[];const g=Math.min(128,m.length),n=await P(m,g),i=n.centroids,c=n.assignments,a=new Array(i.length).fill(0);for(const l of c)a[l]++;const f=[];for(let l=0;l<i.length;l++){const y=i[l],p=a[l];if(p===0)continue;const w={r:Math.round(y[0]),g:Math.round(y[1]),b:Math.round(y[2])},I=E(w);let b=1/0;for(const M of r){const R=S(I,M);R<b&&(b=R)}const z=b*p;f.push({hex:W(w),error:b,count:p,totalError:z})}return f.sort((l,y)=>y.totalError-l.totalError),f.slice(0,o).map(l=>l.hex)}function N(e,t,o,s){const r=e.data,h=e.width,m=e.height,x=new ImageData(new Uint8ClampedArray(r),h,m),d=x.data,u=259*(o+255)/(255*(259-o));for(let g=0;g<d.length;g+=4){let n=d[g],i=d[g+1],c=d[g+2];if(t!==0&&(n+=t,i+=t,c+=t),o!==0&&(n=u*(n-128)+128,i=u*(i-128)+128,c=u*(c-128)+128),s!==0){const a=.2989*n+.587*i+.114*c,f=1+s/100;n=a+(n-a)*f,i=a+(i-a)*f,c=a+(c-a)*f}d[g]=n,d[g+1]=i,d[g+2]=c}return x}self.onmessage=async e=>{const{type:t,imageData:o,settings:s}=e.data;if(t==="suggest"){try{const{palette:f,numSuggestions:l}=s,y=await $(o,f,l||5);self.postMessage({type:"suggestions",suggestions:y})}catch(f){self.postMessage({type:"error",message:f.message})}return}const{targetWidth:r,targetHeight:h,ditherMethod:m,ditherStrength:x,palette:d,resamplingMethod:u,useKmeans:g,kmeansColors:n,brightness:i,contrast:c,saturation:a}=s;try{let f=o;(i&&i!==0||c&&c!==0||a&&a!==0)&&(f=N(o,i||0,c||0,a||0));let l;u==="lanczos"?l=F(f,r,h):u==="bilinear"?l=k(f,r,h):l=_(f,r,h);let y;if(g&&n>0){const p=l.data,w=[];for(let I=0;I<p.length;I+=4)p[I+3]>128&&w.push([p[I],p[I+1],p[I+2]]);if(w.length>0){const b=(await P(w,Math.min(n,w.length))).centroids.map(M=>({r:Math.round(M[0]),g:Math.round(M[1]),b:Math.round(M[2])}));y=b.map(M=>"#"+((1<<24)+(M.r<<16)+(M.g<<8)+M.b).toString(16).slice(1).toUpperCase());const z=b.map(E);for(let M=0;M<p.length;M+=4)if(p[M+3]>128){const R={r:p[M],g:p[M+1],b:p[M+2]},v=T(R,b,z);p[M]=v.r,p[M+1]=v.g,p[M+2]=v.b}}}d&&d.length>0&&U(l,d,m,x),self.postMessage({type:"success",imageData:l,generatedPalette:y})}catch(f){self.postMessage({type:"error",message:f.message})}}})();
//# sourceMappingURL=pixelator.worker-BmmIcnHr.js.map
