(function(){"use strict";function S(n){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})/i.exec(n);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:{r:0,g:0,b:0}}function W(n){let t=n.r/255,e=n.g/255,s=n.b/255;return t=t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92,e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92,s=s>.04045?Math.pow((s+.055)/1.055,2.4):s/12.92,t*=100,e*=100,s*=100,{x:t*.4124+e*.3576+s*.1805,y:t*.2126+e*.7152+s*.0722,z:t*.0193+e*.1192+s*.9505}}function _(n){let t=n.x/95.047,e=n.y/100,s=n.z/108.883;return t=t>.008856?Math.pow(t,1/3):7.787*t+16/116,e=e>.008856?Math.pow(e,1/3):7.787*e+16/116,s=s>.008856?Math.pow(s,1/3):7.787*s+16/116,{l:116*e-16,a:500*(t-e),b:200*(e-s)}}function E(n){return _(W(n))}function G(n,t){const e=n.l-t.l,s=n.a-t.a,r=n.b-t.b;return Math.sqrt(e*e+s*s+r*r)}function F(n,t,e){const s=n.data,r=new ImageData(t,e),h=r.data,m=n.width/t,I=n.height/e;for(let l=0;l<e;l++)for(let y=0;y<t;y++){const d=Math.floor(y*m),c=(Math.floor(l*I)*n.width+d)*4,g=(l*t+y)*4;h[g]=s[c],h[g+1]=s[c+1],h[g+2]=s[c+2],h[g+3]=s[c+3]}return r}function k(n,t,e){const s=n.data,r=new ImageData(t,e),h=r.data;if(t<n.width&&e<n.height){const l=n.width/t,y=n.height/e;for(let d=0;d<e;d++)for(let o=0;o<t;o++){const c=o*l,g=d*y,f=l,x=y;let a=0,M=0,i=0,u=0,b=0;const w=Math.floor(c),R=Math.floor(g),p=Math.min(Math.ceil(c+f),n.width),v=Math.min(Math.ceil(g+x),n.height);for(let A=R;A<v;A++)for(let L=w;L<p;L++){const B=Math.min(L+1,c+f)-Math.max(L,c),X=Math.min(A+1,g+x)-Math.max(A,g),z=B*X;if(z<=0)continue;const Y=(A*n.width+L)*4;a+=s[Y]*z,M+=s[Y+1]*z,i+=s[Y+2]*z,u+=s[Y+3]*z,b+=z}const C=(d*t+o)*4;b>0&&(h[C]=a/b,h[C+1]=M/b,h[C+2]=i/b,h[C+3]=u/b)}return r}const m=(n.width-1)/t,I=(n.height-1)/e;for(let l=0;l<e;l++)for(let y=0;y<t;y++){const d=y*m,o=l*I,c=Math.floor(d),g=Math.floor(o),f=Math.min(c+1,n.width-1),x=Math.min(g+1,n.height-1),a=d-c,M=o-g,i=(l*t+y)*4;for(let u=0;u<4;u++){const b=s[(g*n.width+c)*4+u],w=s[(g*n.width+f)*4+u],R=s[(x*n.width+c)*4+u],p=s[(x*n.width+f)*4+u],v=b*(1-a)+w*a,C=R*(1-a)+p*a,A=v*(1-M)+C*M;h[i+u]=Math.round(A)}}return r}function K(n,t,e){const s=n.data,r=n.width,h=n.height,m=new Float32Array(t*h*4),I=i=>{if(i=Math.abs(i),i===0)return 1;const u=Math.PI*i;return Math.sin(u)/u},l=(i,u)=>i>-u&&i<u?I(i)*I(i/u):0,y=3,d=r/t,o=d>1?d:1,c=y*o;for(let i=0;i<h;i++)for(let u=0;u<t;u++){const b=(u+.5)*d-.5;let w=0,R=0,p=0,v=0,C=0;const A=Math.floor(b-c+1),L=Math.floor(b+c);for(let X=A;X<=L;X++){if(X<0||X>=r)continue;const z=l((b-X)/o,y);if(z===0)continue;const Y=(i*r+X)*4;w+=s[Y]*z,R+=s[Y+1]*z,p+=s[Y+2]*z,v+=s[Y+3]*z,C+=z}const B=(i*t+u)*4;C>0&&(m[B]=w/C,m[B+1]=R/C,m[B+2]=p/C,m[B+3]=v/C)}const g=new ImageData(t,e),f=g.data,x=h/e,a=x>1?x:1,M=y*a;for(let i=0;i<t;i++)for(let u=0;u<e;u++){const b=(u+.5)*x-.5;let w=0,R=0,p=0,v=0,C=0;const A=Math.floor(b-M+1),L=Math.floor(b+M);for(let X=A;X<=L;X++){if(X<0||X>=h)continue;const z=l((b-X)/a,y);if(z===0)continue;const Y=(X*t+i)*4;w+=m[Y]*z,R+=m[Y+1]*z,p+=m[Y+2]*z,v+=m[Y+3]*z,C+=z}const B=(u*t+i)*4;C>0&&(f[B]=Math.max(0,Math.min(255,w/C)),f[B+1]=Math.max(0,Math.min(255,R/C)),f[B+2]=Math.max(0,Math.min(255,p/C)),f[B+3]=Math.max(0,Math.min(255,v/C)))}return g}const H={"bayer-4x4":{matrix:[[0,8,2,10],[12,4,14,6],[3,11,1,9],[15,7,13,5]],size:4,divisor:16},"bayer-8x8":{matrix:[[0,32,8,40,2,34,10,42],[48,16,56,24,50,18,58,26],[12,44,4,36,14,46,6,38],[60,28,52,20,62,30,54,22],[3,35,11,43,1,33,9,41],[51,19,59,27,49,17,57,25],[15,47,7,39,13,45,5,37],[63,31,55,23,61,29,53,21]],size:8,divisor:64},"halftone-dot":{matrix:[[12,5,6,13],[4,0,1,7],[8,2,3,11],[14,9,10,15]],size:4,divisor:16},"diagonal-line":{matrix:[[15,7,3,7],[7,3,7,15],[3,7,15,7],[7,15,7,3]],size:4,divisor:16},"cross-hatch":{matrix:[[0,8,0,8],[8,15,8,15],[0,8,0,8],[8,15,8,15]],size:4,divisor:16},grid:{matrix:[[0,0,0,0],[0,15,15,0],[0,15,15,0],[0,0,0,0]],size:4,divisor:16}},U={"floyd-steinberg":[{dx:1,dy:0,f:7/16},{dx:-1,dy:1,f:3/16},{dx:0,dy:1,f:5/16},{dx:1,dy:1,f:1/16}],burkes:[{dx:1,dy:0,f:8/32},{dx:2,dy:0,f:4/32},{dx:-2,dy:1,f:2/32},{dx:-1,dy:1,f:4/32},{dx:0,dy:1,f:8/32},{dx:1,dy:1,f:4/32},{dx:2,dy:1,f:2/32}],stucki:[{dx:1,dy:0,f:8/42},{dx:2,dy:0,f:4/42},{dx:-2,dy:1,f:2/42},{dx:-1,dy:1,f:4/42},{dx:0,dy:1,f:8/42},{dx:1,dy:1,f:4/42},{dx:2,dy:1,f:2/42},{dx:-2,dy:2,f:1/42},{dx:-1,dy:2,f:2/42},{dx:0,dy:2,f:4/42},{dx:1,dy:2,f:2/42},{dx:2,dy:2,f:1/42}],"sierra-2":[{dx:1,dy:0,f:4/16},{dx:2,dy:0,f:3/16},{dx:-2,dy:1,f:1/16},{dx:-1,dy:1,f:2/16},{dx:0,dy:1,f:3/16},{dx:1,dy:1,f:2/16},{dx:2,dy:1,f:1/16}],"sierra-lite":[{dx:1,dy:0,f:2/4},{dx:-1,dy:1,f:1/4},{dx:0,dy:1,f:1/4}]};function T(n,t,e){const s=E(n);let r=1/0,h=t[0];for(let m=0;m<t.length;m++){const I=G(s,e[m]);I<r&&(r=I,h=t[m])}return h}function $(n,t,e,s){const r=n.data,h=n.width,m=n.height,I=t.map(S),l=I.map(E),y=s/100;if(e in H){const d=H[e],o=d.matrix,c=d.size,g=d.divisor,f=64;for(let x=0;x<m;x++)for(let a=0;a<h;a++){const M=(x*h+a)*4;if(r[M+3]<128){r[M+3]=0;continue}const i=a%c,u=x%c,w=(o[u][i]/g-.5)*f*y,R={r:Math.max(0,Math.min(255,r[M]+w)),g:Math.max(0,Math.min(255,r[M+1]+w)),b:Math.max(0,Math.min(255,r[M+2]+w))},p=T(R,I,l);r[M]=p.r,r[M+1]=p.g,r[M+2]=p.b,r[M+3]=255}}else{const d=new Float32Array(r),o=U[e];for(let c=0;c<m;c++)for(let g=0;g<h;g++){const f=(c*h+g)*4;if(d[f+3]<128){r[f+3]=0;continue}const x={r:d[f],g:d[f+1],b:d[f+2]},a=T(x,I,l);if(r[f]=a.r,r[f+1]=a.g,r[f+2]=a.b,r[f+3]=255,e==="none"||!o)continue;const M={r:(x.r-a.r)*y,g:(x.g-a.g)*y,b:(x.b-a.b)*y};for(const i of o){const u=g+i.dx,b=c+i.dy;if(u>=0&&u<h&&b>=0&&b<m){const w=(b*h+u)*4;if(d[w+3]<128)continue;d[w]+=M.r*i.f,d[w+1]+=M.g*i.f,d[w+2]+=M.b*i.f}}}}}function P(n,t,e=20){return new Promise(s=>{if(t>n.length&&(t=n.length),t===0){s({centroids:[],assignments:[]});return}let r=[];const h=[...n];for(let I=0;I<t;I++){const l=Math.floor(Math.random()*h.length);r.push(h.splice(l,1)[0])}let m=new Array(n.length);for(let I=0;I<e;I++){for(let o=0;o<n.length;o++){let c=1/0,g=-1;for(let f=0;f<t;f++){const x=(n[o][0]-r[f][0])**2+(n[o][1]-r[f][1])**2+(n[o][2]-r[f][2])**2;x<c&&(c=x,g=f)}m[o]=g}const l=Array.from({length:t},()=>[0,0,0]),y=new Array(t).fill(0);for(let o=0;o<n.length;o++){const c=m[o];l[c][0]+=n[o][0],l[c][1]+=n[o][1],l[c][2]+=n[o][2],y[c]++}for(let o=0;o<t;o++)y[o]>0?(l[o][0]/=y[o],l[o][1]/=y[o],l[o][2]/=y[o]):l[o]=n[Math.floor(Math.random()*n.length)];let d=!1;for(let o=0;o<t;o++)if(r[o][0]!==l[o][0]||r[o][1]!==l[o][1]||r[o][2]!==l[o][2]){d=!0;break}if(r=l,!d)break}s({centroids:r,assignments:m})})}function N(n){const t=e=>{const s=Math.round(e).toString(16);return s.length===1?"0"+s:s};return`#${t(n.r)}${t(n.g)}${t(n.b)}`.toUpperCase()}async function j(n,t,e){if(t.length===0)return[];const r=t.map(S).map(E),h=n.data,m=[],I=h.length/4,y=Math.ceil(I/4096)*4;for(let a=0;a<h.length;a+=y)h[a+3]>128&&m.push([h[a],h[a+1],h[a+2]]);if(m.length===0)return[];const d=Math.min(128,m.length),o=await P(m,d),c=o.centroids,g=o.assignments,f=new Array(c.length).fill(0);for(const a of g)f[a]++;const x=[];for(let a=0;a<c.length;a++){const M=c[a],i=f[a];if(i===0)continue;const u={r:Math.round(M[0]),g:Math.round(M[1]),b:Math.round(M[2])},b=E(u);let w=1/0;for(const p of r){const v=G(b,p);v<w&&(w=v)}const R=w*i;x.push({hex:N(u),error:w,count:i,totalError:R})}return x.sort((a,M)=>M.totalError-a.totalError),x.slice(0,e).map(a=>a.hex)}function q(n,t,e,s){const r=n.data,h=n.width,m=n.height,I=new ImageData(new Uint8ClampedArray(r),h,m),l=I.data,y=259*(e+255)/(255*(259-e));for(let d=0;d<l.length;d+=4){let o=l[d],c=l[d+1],g=l[d+2];if(t!==0&&(o+=t,c+=t,g+=t),e!==0&&(o=y*(o-128)+128,c=y*(c-128)+128,g=y*(g-128)+128),s!==0){const f=.2989*o+.587*c+.114*g,x=1+s/100;o=f+(o-f)*x,c=f+(c-f)*x,g=f+(g-f)*x}l[d]=o,l[d+1]=c,l[d+2]=g}return I}self.onmessage=async n=>{const{type:t,imageData:e,settings:s}=n.data;if(t==="suggest"){try{const{palette:x,numSuggestions:a}=s,M=await j(e,x,a||5);self.postMessage({type:"suggestions",suggestions:M})}catch(x){self.postMessage({type:"error",message:x.message})}return}const{targetWidth:r,targetHeight:h,ditherMethod:m,ditherStrength:I,palette:l,resamplingMethod:y,useKmeans:d,kmeansColors:o,brightness:c,contrast:g,saturation:f}=s;try{let x=e;(c&&c!==0||g&&g!==0||f&&f!==0)&&(x=q(e,c||0,g||0,f||0));let a;y==="lanczos"?a=K(x,r,h):y==="bilinear"?a=k(x,r,h):a=F(x,r,h);let M;if(d&&o>0){const i=a.data,u=[];for(let b=0;b<i.length;b+=4)i[b+3]>128&&u.push([i[b],i[b+1],i[b+2]]);if(u.length>0){const w=(await P(u,Math.min(o,u.length))).centroids.map(p=>({r:Math.round(p[0]),g:Math.round(p[1]),b:Math.round(p[2])}));M=w.map(p=>"#"+((1<<24)+(p.r<<16)+(p.g<<8)+p.b).toString(16).slice(1).toUpperCase());const R=w.map(E);for(let p=0;p<i.length;p+=4)if(i[p+3]>128){const v={r:i[p],g:i[p+1],b:i[p+2]},C=T(v,w,R);i[p]=C.r,i[p+1]=C.g,i[p+2]=C.b}}}l&&l.length>0&&$(a,l,m,I),self.postMessage({type:"success",imageData:a,generatedPalette:M})}catch(x){self.postMessage({type:"error",message:x.message})}}})();
//# sourceMappingURL=pixelator.worker-BHgiNrIb.js.map
