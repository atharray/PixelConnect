(function(){"use strict";function Y(n){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})/i.exec(n);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:{r:0,g:0,b:0}}function H(n){let t=n.r/255,o=n.g/255,s=n.b/255;return t=t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92,o=o>.04045?Math.pow((o+.055)/1.055,2.4):o/12.92,s=s>.04045?Math.pow((s+.055)/1.055,2.4):s/12.92,t*=100,o*=100,s*=100,{x:t*.4124+o*.3576+s*.1805,y:t*.2126+o*.7152+s*.0722,z:t*.0193+o*.1192+s*.9505}}function P(n){let t=n.x/95.047,o=n.y/100,s=n.z/108.883;return t=t>.008856?Math.pow(t,1/3):7.787*t+16/116,o=o>.008856?Math.pow(o,1/3):7.787*o+16/116,s=s>.008856?Math.pow(s,1/3):7.787*s+16/116,{l:116*o-16,a:500*(t-o),b:200*(o-s)}}function B(n){return P(H(n))}function G(n,t){const o=n.l-t.l,s=n.a-t.a,r=n.b-t.b;return Math.sqrt(o*o+s*s+r*r)}function _(n,t,o){const s=n.data,r=new ImageData(t,o),g=r.data,m=n.width/t,u=n.height/o;for(let d=0;d<o;d++)for(let y=0;y<t;y++){const x=Math.floor(y*m),i=(Math.floor(d*u)*n.width+x)*4,c=(d*t+y)*4;g[c]=s[i],g[c+1]=s[i+1],g[c+2]=s[i+2],g[c+3]=s[i+3]}return r}function k(n,t,o){const s=n.data,r=new ImageData(t,o),g=r.data,m=(n.width-1)/t,u=(n.height-1)/o;for(let d=0;d<o;d++)for(let y=0;y<t;y++){const x=y*m,e=d*u,i=Math.floor(x),c=Math.floor(e),a=Math.min(i+1,n.width-1),h=Math.min(c+1,n.height-1),l=x-i,f=e-c,b=(d*t+y)*4;for(let p=0;p<4;p++){const I=s[(c*n.width+i)*4+p],M=s[(c*n.width+a)*4+p],w=s[(h*n.width+i)*4+p],z=s[(h*n.width+a)*4+p],C=I*(1-l)+M*l,T=w*(1-l)+z*l,R=C*(1-f)+T*f;g[b+p]=Math.round(R)}}return r}function F(n,t,o){const s=n.data,r=n.width,g=n.height,m=new ImageData(t,o),u=m.data,d=c=>{if(c=Math.abs(c),c===0)return 1;const a=Math.PI*c;return Math.sin(a)/a},y=(c,a)=>c>-a&&c<a?d(c)*d(c/a):0,x=r/t,e=g/o,i=3;for(let c=0;c<o;c++)for(let a=0;a<t;a++){const h=(c+.5)*e-.5,l=(a+.5)*x-.5;let f=0,b=0,p=0,I=0,M=0;const w=Math.floor(l)-i+1,z=Math.floor(l)+i,C=Math.floor(h)-i+1,T=Math.floor(h)+i;for(let v=C;v<=T;v++)if(!(v<0||v>=g))for(let A=w;A<=z;A++){if(A<0||A>=r)continue;const L=y(l-A,i)*y(h-v,i);if(L===0)continue;const E=(v*r+A)*4;f+=s[E]*L,b+=s[E+1]*L,p+=s[E+2]*L,I+=s[E+3]*L,M+=L}const R=(c*t+a)*4;M>0?(u[R]=f/M,u[R+1]=b/M,u[R+2]=p/M,u[R+3]=I/M):(u[R]=0,u[R+1]=0,u[R+2]=0,u[R+3]=0)}return m}const S={"bayer-4x4":{matrix:[[0,8,2,10],[12,4,14,6],[3,11,1,9],[15,7,13,5]],size:4,divisor:16},"bayer-8x8":{matrix:[[0,32,8,40,2,34,10,42],[48,16,56,24,50,18,58,26],[12,44,4,36,14,46,6,38],[60,28,52,20,62,30,54,22],[3,35,11,43,1,33,9,41],[51,19,59,27,49,17,57,25],[15,47,7,39,13,45,5,37],[63,31,55,23,61,29,53,21]],size:8,divisor:64},"halftone-dot":{matrix:[[12,5,6,13],[4,0,1,7],[8,2,3,11],[14,9,10,15]],size:4,divisor:16},"diagonal-line":{matrix:[[15,7,3,7],[7,3,7,15],[3,7,15,7],[7,15,7,3]],size:4,divisor:16},"cross-hatch":{matrix:[[0,8,0,8],[8,15,8,15],[0,8,0,8],[8,15,8,15]],size:4,divisor:16},grid:{matrix:[[0,0,0,0],[0,15,15,0],[0,15,15,0],[0,0,0,0]],size:4,divisor:16}},K={"floyd-steinberg":[{dx:1,dy:0,f:7/16},{dx:-1,dy:1,f:3/16},{dx:0,dy:1,f:5/16},{dx:1,dy:1,f:1/16}],burkes:[{dx:1,dy:0,f:8/32},{dx:2,dy:0,f:4/32},{dx:-2,dy:1,f:2/32},{dx:-1,dy:1,f:4/32},{dx:0,dy:1,f:8/32},{dx:1,dy:1,f:4/32},{dx:2,dy:1,f:2/32}],stucki:[{dx:1,dy:0,f:8/42},{dx:2,dy:0,f:4/42},{dx:-2,dy:1,f:2/42},{dx:-1,dy:1,f:4/42},{dx:0,dy:1,f:8/42},{dx:1,dy:1,f:4/42},{dx:2,dy:1,f:2/42},{dx:-2,dy:2,f:1/42},{dx:-1,dy:2,f:2/42},{dx:0,dy:2,f:4/42},{dx:1,dy:2,f:2/42},{dx:2,dy:2,f:1/42}],"sierra-2":[{dx:1,dy:0,f:4/16},{dx:2,dy:0,f:3/16},{dx:-2,dy:1,f:1/16},{dx:-1,dy:1,f:2/16},{dx:0,dy:1,f:3/16},{dx:1,dy:1,f:2/16},{dx:2,dy:1,f:1/16}],"sierra-lite":[{dx:1,dy:0,f:2/4},{dx:-1,dy:1,f:1/4},{dx:0,dy:1,f:1/4}]};function X(n,t,o){const s=B(n);let r=1/0,g=t[0];for(let m=0;m<t.length;m++){const u=G(s,o[m]);u<r&&(r=u,g=t[m])}return g}function W(n,t,o,s){const r=n.data,g=n.width,m=n.height,u=t.map(Y),d=u.map(B),y=s/100;if(o in S){const x=S[o],e=x.matrix,i=x.size,c=x.divisor,a=64;for(let h=0;h<m;h++)for(let l=0;l<g;l++){const f=(h*g+l)*4;if(r[f+3]<128){r[f+3]=0;continue}const b=l%i,p=h%i,M=(e[p][b]/c-.5)*a*y,w={r:Math.max(0,Math.min(255,r[f]+M)),g:Math.max(0,Math.min(255,r[f+1]+M)),b:Math.max(0,Math.min(255,r[f+2]+M))},z=X(w,u,d);r[f]=z.r,r[f+1]=z.g,r[f+2]=z.b,r[f+3]=255}}else{const x=new Float32Array(r),e=K[o];for(let i=0;i<m;i++)for(let c=0;c<g;c++){const a=(i*g+c)*4;if(x[a+3]<128){r[a+3]=0;continue}const h={r:x[a],g:x[a+1],b:x[a+2]},l=X(h,u,d);if(r[a]=l.r,r[a+1]=l.g,r[a+2]=l.b,r[a+3]=255,o==="none"||!e)continue;const f={r:(h.r-l.r)*y,g:(h.g-l.g)*y,b:(h.b-l.b)*y};for(const b of e){const p=c+b.dx,I=i+b.dy;if(p>=0&&p<g&&I>=0&&I<m){const M=(I*g+p)*4;if(x[M+3]<128)continue;x[M]+=f.r*b.f,x[M+1]+=f.g*b.f,x[M+2]+=f.b*b.f}}}}}function D(n,t,o=20){return new Promise(s=>{if(t>n.length&&(t=n.length),t===0){s({centroids:[],assignments:[]});return}let r=[];const g=[...n];for(let u=0;u<t;u++){const d=Math.floor(Math.random()*g.length);r.push(g.splice(d,1)[0])}let m=new Array(n.length);for(let u=0;u<o;u++){for(let e=0;e<n.length;e++){let i=1/0,c=-1;for(let a=0;a<t;a++){const h=(n[e][0]-r[a][0])**2+(n[e][1]-r[a][1])**2+(n[e][2]-r[a][2])**2;h<i&&(i=h,c=a)}m[e]=c}const d=Array.from({length:t},()=>[0,0,0]),y=new Array(t).fill(0);for(let e=0;e<n.length;e++){const i=m[e];d[i][0]+=n[e][0],d[i][1]+=n[e][1],d[i][2]+=n[e][2],y[i]++}for(let e=0;e<t;e++)y[e]>0?(d[e][0]/=y[e],d[e][1]/=y[e],d[e][2]/=y[e]):d[e]=n[Math.floor(Math.random()*n.length)];let x=!1;for(let e=0;e<t;e++)if(r[e][0]!==d[e][0]||r[e][1]!==d[e][1]||r[e][2]!==d[e][2]){x=!0;break}if(r=d,!x)break}s({centroids:r,assignments:m})})}function $(n){const t=o=>{const s=Math.round(o).toString(16);return s.length===1?"0"+s:s};return`#${t(n.r)}${t(n.g)}${t(n.b)}`.toUpperCase()}async function N(n,t,o){if(t.length===0)return[];const r=t.map(Y).map(B),g=n.data,m=[],u=g.length/4,y=Math.ceil(u/4096)*4;for(let l=0;l<g.length;l+=y)g[l+3]>128&&m.push([g[l],g[l+1],g[l+2]]);if(m.length===0)return[];const x=Math.min(128,m.length),e=await D(m,x),i=e.centroids,c=e.assignments,a=new Array(i.length).fill(0);for(const l of c)a[l]++;const h=[];for(let l=0;l<i.length;l++){const f=i[l],b=a[l];if(b===0)continue;const p={r:Math.round(f[0]),g:Math.round(f[1]),b:Math.round(f[2])},I=B(p);let M=1/0;for(const z of r){const C=G(I,z);C<M&&(M=C)}const w=M*b;h.push({hex:$(p),error:M,count:b,totalError:w})}return h.sort((l,f)=>f.totalError-l.totalError),h.slice(0,o).map(l=>l.hex)}function U(n,t,o,s){const r=n.data,g=n.width,m=n.height,u=new ImageData(new Uint8ClampedArray(r),g,m),d=u.data,y=259*(o+255)/(255*(259-o));for(let x=0;x<d.length;x+=4){let e=d[x],i=d[x+1],c=d[x+2];if(t!==0&&(e+=t,i+=t,c+=t),o!==0&&(e=y*(e-128)+128,i=y*(i-128)+128,c=y*(c-128)+128),s!==0){const a=.2989*e+.587*i+.114*c,h=1+s/100;e=a+(e-a)*h,i=a+(i-a)*h,c=a+(c-a)*h}d[x]=e,d[x+1]=i,d[x+2]=c}return u}self.onmessage=async n=>{const{type:t,imageData:o,settings:s}=n.data;if(t==="suggest"){try{const{palette:h,numSuggestions:l}=s,f=await N(o,h,l||5);self.postMessage({type:"suggestions",suggestions:f})}catch(h){self.postMessage({type:"error",message:h.message})}return}const{targetWidth:r,targetHeight:g,ditherMethod:m,ditherStrength:u,palette:d,resamplingMethod:y,useKmeans:x,kmeansColors:e,brightness:i,contrast:c,saturation:a}=s;try{let h=o;(i&&i!==0||c&&c!==0||a&&a!==0)&&(h=U(o,i||0,c||0,a||0));let l;if(y==="lanczos"?l=F(h,r,g):y==="bilinear"?l=k(h,r,g):l=_(h,r,g),x&&e>0){const f=l.data,b=[];for(let p=0;p<f.length;p+=4)f[p+3]>128&&b.push([f[p],f[p+1],f[p+2]]);if(b.length>0){const I=(await D(b,Math.min(e,b.length))).centroids.map(w=>({r:Math.round(w[0]),g:Math.round(w[1]),b:Math.round(w[2])})),M=I.map(B);for(let w=0;w<f.length;w+=4)if(f[w+3]>128){const z={r:f[w],g:f[w+1],b:f[w+2]},C=X(z,I,M);f[w]=C.r,f[w+1]=C.g,f[w+2]=C.b}}}d&&d.length>0&&W(l,d,m,u),self.postMessage({type:"success",imageData:l})}catch(h){self.postMessage({type:"error",message:h.message})}}})();
//# sourceMappingURL=pixelator.worker-gL8ntdoU.js.map
