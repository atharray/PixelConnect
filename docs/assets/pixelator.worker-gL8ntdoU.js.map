{"version":3,"file":"pixelator.worker-gL8ntdoU.js","sources":["../src/workers/pixelator.worker.ts"],"sourcesContent":["// src/workers/pixelator.worker.ts\r\n\r\nconst GEOPIXELS_PALETTE = [\r\n  \"#FFFFFF\",\"#F4F59F\",\"#FFCA3A\",\"#FF9F1C\",\"#FF595E\",\"#E71D36\",\"#F3BBC2\",\"#FF85A1\",\"#BD637D\",\"#CDB4DB\",\"#6A4C93\",\"#4D194D\",\"#A8D0DC\",\"#2EC4B6\",\"#1A535C\",\"#6D9DCD\",\"#1982C4\",\"#A1C181\",\"#8AC926\",\"#A0A0A0\",\"#6B4226\",\"#505050\",\"#CFD078\",\"#145A7A\",\"#8B1D24\",\"#C07F7A\",\"#C49A6C\",\"#5B7B1C\",\"#000000\"\r\n];\r\n\r\nconst WPLACE_PALETTE = [\r\n  \"#000000\",\"#3c3c3c\",\"#787878\",\"#aaaaaa\",\"#d2d2d2\",\"#ffffff\",\"#600018\",\"#a50e1e\",\"#ed1c24\",\"#fa8072\",\"#e45c1a\",\"#ff7f27\",\"#f6aa09\",\"#f9dd3b\",\"#fffabc\",\"#9c8431\",\"#c5ad31\",\"#e8d45f\",\"#4a6b3a\",\"#5a944a\",\"#84c573\",\"#0eb968\",\"#13e67b\",\"#87ff5e\",\"#0c816e\",\"#10aea6\",\"#13e1be\",\"#0f799f\",\"#60f7f2\",\"#bbfaf2\",\"#28509e\",\"#4093e4\",\"#7dc7ff\",\"#4d31b8\",\"#6b50f6\",\"#99b1fb\",\"#4a4284\",\"#7a71c4\",\"#b5aef1\",\"#780c99\",\"#aa38b9\",\"#e09ff9\",\"#cb007a\",\"#ec1f80\",\"#f38da9\",\"#9b5249\",\"#d18078\",\"#fab6a4\",\"#684634\",\"#95682a\",\"#dba463\",\"#7b6352\",\"#9c846b\",\"#d6b594\",\"#d18051\",\"#f8b277\",\"#ffc5a5\",\"#6d643f\",\"#948c6b\",\"#cdc59e\",\"#333941\",\"#6d758d\",\"#b3b9d1\"\r\n];\r\n\r\ninterface RGB { r: number; g: number; b: number; }\r\ninterface LAB { l: number; a: number; b: number; }\r\n\r\n// --- Color Conversion & Distance ---\r\n\r\nfunction hexToRgb(hex: string): RGB {\r\n  const result = /^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})/i.exec(hex);\r\n  return result ? {\r\n    r: parseInt(result[1], 16),\r\n    g: parseInt(result[2], 16),\r\n    b: parseInt(result[3], 16)\r\n  } : { r: 0, g: 0, b: 0 };\r\n}\r\n\r\nfunction rgbToXyz(c: RGB) {\r\n  let r = c.r / 255;\r\n  let g = c.g / 255;\r\n  let b = c.b / 255;\r\n\r\n  r = r > 0.04045 ? Math.pow(((r + 0.055) / 1.055), 2.4) : r / 12.92;\r\n  g = g > 0.04045 ? Math.pow(((g + 0.055) / 1.055), 2.4) : g / 12.92;\r\n  b = b > 0.04045 ? Math.pow(((b + 0.055) / 1.055), 2.4) : b / 12.92;\r\n\r\n  r *= 100; g *= 100; b *= 100;\r\n\r\n  return {\r\n    x: r * 0.4124 + g * 0.3576 + b * 0.1805,\r\n    y: r * 0.2126 + g * 0.7152 + b * 0.0722,\r\n    z: r * 0.0193 + g * 0.1192 + b * 0.9505\r\n  };\r\n}\r\n\r\nfunction xyzToLab(c: { x: number, y: number, z: number }): LAB {\r\n  let x = c.x / 95.047;\r\n  let y = c.y / 100.000;\r\n  let z = c.z / 108.883;\r\n\r\n  x = x > 0.008856 ? Math.pow(x, 1/3) : (7.787 * x) + (16 / 116);\r\n  y = y > 0.008856 ? Math.pow(y, 1/3) : (7.787 * y) + (16 / 116);\r\n  z = z > 0.008856 ? Math.pow(z, 1/3) : (7.787 * z) + (16 / 116);\r\n\r\n  return {\r\n    l: (116 * y) - 16,\r\n    a: 500 * (x - y),\r\n    b: 200 * (y - z)\r\n  };\r\n}\r\n\r\nfunction rgbToLab(c: RGB): LAB {\r\n  return xyzToLab(rgbToXyz(c));\r\n}\r\n\r\nfunction getDeltaE(labA: LAB, labB: LAB): number {\r\n  const deltaL = labA.l - labB.l;\r\n  const deltaA = labA.a - labB.a;\r\n  const deltaB = labA.b - labB.b;\r\n  return Math.sqrt(deltaL * deltaL + deltaA * deltaA + deltaB * deltaB);\r\n}\r\n\r\n// --- Resizing ---\r\n\r\nfunction resampleNearest(srcData: ImageData, width: number, height: number): ImageData {\r\n  const src = srcData.data;\r\n  const dest = new ImageData(width, height);\r\n  const destData = dest.data;\r\n  const xRatio = srcData.width / width;\r\n  const yRatio = srcData.height / height;\r\n\r\n  for (let y = 0; y < height; y++) {\r\n    for (let x = 0; x < width; x++) {\r\n      const srcX = Math.floor(x * xRatio);\r\n      const srcY = Math.floor(y * yRatio);\r\n      const srcIdx = (srcY * srcData.width + srcX) * 4;\r\n      const destIdx = (y * width + x) * 4;\r\n      \r\n      destData[destIdx] = src[srcIdx];\r\n      destData[destIdx + 1] = src[srcIdx + 1];\r\n      destData[destIdx + 2] = src[srcIdx + 2];\r\n      destData[destIdx + 3] = src[srcIdx + 3];\r\n    }\r\n  }\r\n  return dest;\r\n}\r\n\r\nfunction resampleBilinear(srcData: ImageData, width: number, height: number): ImageData {\r\n  const src = srcData.data;\r\n  const dest = new ImageData(width, height);\r\n  const destData = dest.data;\r\n  const xRatio = (srcData.width - 1) / width;\r\n  const yRatio = (srcData.height - 1) / height;\r\n\r\n  for (let y = 0; y < height; y++) {\r\n    for (let x = 0; x < width; x++) {\r\n      const srcX = x * xRatio;\r\n      const srcY = y * yRatio;\r\n      \r\n      const x1 = Math.floor(srcX);\r\n      const y1 = Math.floor(srcY);\r\n      const x2 = Math.min(x1 + 1, srcData.width - 1);\r\n      const y2 = Math.min(y1 + 1, srcData.height - 1);\r\n      \r\n      const dx = srcX - x1;\r\n      const dy = srcY - y1;\r\n      \r\n      const destIdx = (y * width + x) * 4;\r\n      \r\n      for (let c = 0; c < 4; c++) {\r\n        const v1 = src[(y1 * srcData.width + x1) * 4 + c];\r\n        const v2 = src[(y1 * srcData.width + x2) * 4 + c];\r\n        const v3 = src[(y2 * srcData.width + x1) * 4 + c];\r\n        const v4 = src[(y2 * srcData.width + x2) * 4 + c];\r\n        \r\n        const top = v1 * (1 - dx) + v2 * dx;\r\n        const bottom = v3 * (1 - dx) + v4 * dx;\r\n        const value = top * (1 - dy) + bottom * dy;\r\n        \r\n        destData[destIdx + c] = Math.round(value);\r\n      }\r\n    }\r\n  }\r\n  return dest;\r\n}\r\n\r\nfunction resampleLanczos(imageData: ImageData, width: number, height: number): ImageData {\r\n    const srcData = imageData.data;\r\n    const srcWidth = imageData.width;\r\n    const srcHeight = imageData.height;\r\n    const destImageData = new ImageData(width, height);\r\n    const destData = destImageData.data;\r\n\r\n    const sinc = (x: number) => {\r\n        x = Math.abs(x);\r\n        if (x === 0) return 1;\r\n        const piX = Math.PI * x;\r\n        return Math.sin(piX) / piX;\r\n    };\r\n\r\n    const lanczosKernel = (x: number, a: number) => {\r\n        if (x > -a && x < a) {\r\n            return sinc(x) * sinc(x / a);\r\n        }\r\n        return 0;\r\n    };\r\n\r\n    const ratioX = srcWidth / width;\r\n    const ratioY = srcHeight / height;\r\n    const a = 3;\r\n\r\n    for (let dy = 0; dy < height; dy++) {\r\n        for (let dx = 0; dx < width; dx++) {\r\n            const sy = (dy + 0.5) * ratioY - 0.5;\r\n            const sx = (dx + 0.5) * ratioX - 0.5;\r\n\r\n            let r = 0, g = 0, b = 0, a_val = 0, totalWeight = 0;\r\n\r\n            const startX = Math.floor(sx) - a + 1;\r\n            const endX = Math.floor(sx) + a;\r\n            const startY = Math.floor(sy) - a + 1;\r\n            const endY = Math.floor(sy) + a;\r\n\r\n            for (let y = startY; y <= endY; y++) {\r\n                if (y < 0 || y >= srcHeight) continue;\r\n                for (let x = startX; x <= endX; x++) {\r\n                    if (x < 0 || x >= srcWidth) continue;\r\n\r\n                    const weight = lanczosKernel(sx - x, a) * lanczosKernel(sy - y, a);\r\n                    if (weight === 0) continue;\r\n\r\n                    const srcIndex = (y * srcWidth + x) * 4;\r\n                    r += srcData[srcIndex] * weight;\r\n                    g += srcData[srcIndex + 1] * weight;\r\n                    b += srcData[srcIndex + 2] * weight;\r\n                    a_val += srcData[srcIndex + 3] * weight;\r\n                    totalWeight += weight;\r\n                }\r\n            }\r\n\r\n            const destIndex = (dy * width + dx) * 4;\r\n            if (totalWeight > 0) {\r\n                destData[destIndex] = r / totalWeight;\r\n                destData[destIndex + 1] = g / totalWeight;\r\n                destData[destIndex + 2] = b / totalWeight;\r\n                destData[destIndex + 3] = a_val / totalWeight;\r\n            } else {\r\n                 // Fallback for edge cases\r\n                 destData[destIndex] = 0;\r\n                 destData[destIndex+1] = 0;\r\n                 destData[destIndex+2] = 0;\r\n                 destData[destIndex+3] = 0;\r\n            }\r\n        }\r\n    }\r\n    return destImageData;\r\n}\r\n\r\n// --- Dithering ---\r\n\r\nconst ditherMatrices: Record<string, { matrix: number[][], size: number, divisor: number }> = {\r\n    'bayer-4x4': {\r\n        matrix: [[0, 8, 2, 10], [12, 4, 14, 6], [3, 11, 1, 9], [15, 7, 13, 5]],\r\n        size: 4, divisor: 16\r\n    },\r\n    'bayer-8x8': {\r\n        matrix: [\r\n            [0, 32, 8, 40, 2, 34, 10, 42], [48, 16, 56, 24, 50, 18, 58, 26],\r\n            [12, 44, 4, 36, 14, 46, 6, 38], [60, 28, 52, 20, 62, 30, 54, 22],\r\n            [3, 35, 11, 43, 1, 33, 9, 41], [51, 19, 59, 27, 49, 17, 57, 25],\r\n            [15, 47, 7, 39, 13, 45, 5, 37], [63, 31, 55, 23, 61, 29, 53, 21]\r\n        ],\r\n        size: 8, divisor: 64\r\n    },\r\n    'halftone-dot': {\r\n        matrix: [[12, 5, 6, 13], [4, 0, 1, 7], [8, 2, 3, 11], [14, 9, 10, 15]],\r\n        size: 4, divisor: 16\r\n    },\r\n    'diagonal-line': {\r\n        matrix: [[15, 7, 3, 7], [7, 3, 7, 15], [3, 7, 15, 7], [7, 15, 7, 3]],\r\n        size: 4, divisor: 16\r\n    },\r\n    'cross-hatch': {\r\n        matrix: [[0, 8, 0, 8], [8, 15, 8, 15], [0, 8, 0, 8], [8, 15, 8, 15]],\r\n        size: 4, divisor: 16\r\n    },\r\n    'grid': {\r\n        matrix: [[0, 0, 0, 0], [0, 15, 15, 0], [0, 15, 15, 0], [0, 0, 0, 0]],\r\n        size: 4, divisor: 16\r\n    }\r\n};\r\n\r\nconst errorKernels: Record<string, { dx: number, dy: number, f: number }[]> = {\r\n    'floyd-steinberg': [\r\n        { dx: 1, dy: 0, f: 7 / 16 }, { dx: -1, dy: 1, f: 3 / 16 }, { dx: 0, dy: 1, f: 5 / 16 }, { dx: 1, dy: 1, f: 1 / 16 }\r\n    ],\r\n    'burkes': [\r\n        { dx: 1, dy: 0, f: 8 / 32 }, { dx: 2, dy: 0, f: 4 / 32 }, { dx: -2, dy: 1, f: 2 / 32 }, { dx: -1, dy: 1, f: 4 / 32 },\r\n        { dx: 0, dy: 1, f: 8 / 32 }, { dx: 1, dy: 1, f: 4 / 32 }, { dx: 2, dy: 1, f: 2 / 32 }\r\n    ],\r\n    'stucki': [\r\n        { dx: 1, dy: 0, f: 8 / 42 }, { dx: 2, dy: 0, f: 4 / 42 }, { dx: -2, dy: 1, f: 2 / 42 }, { dx: -1, dy: 1, f: 4 / 42 },\r\n        { dx: 0, dy: 1, f: 8 / 42 }, { dx: 1, dy: 1, f: 4 / 42 }, { dx: 2, dy: 1, f: 2 / 42 }, { dx: -2, dy: 2, f: 1 / 42 },\r\n        { dx: -1, dy: 2, f: 2 / 42 }, { dx: 0, dy: 2, f: 4 / 42 }, { dx: 1, dy: 2, f: 2 / 42 }, { dx: 2, dy: 2, f: 1 / 42 }\r\n    ],\r\n    'sierra-2': [\r\n        { dx: 1, dy: 0, f: 4 / 16 }, { dx: 2, dy: 0, f: 3 / 16 }, { dx: -2, dy: 1, f: 1 / 16 }, { dx: -1, dy: 1, f: 2 / 16 },\r\n        { dx: 0, dy: 1, f: 3 / 16 }, { dx: 1, dy: 1, f: 2 / 16 }, { dx: 2, dy: 1, f: 1 / 16 }\r\n    ],\r\n    'sierra-lite': [\r\n        { dx: 1, dy: 0, f: 2 / 4 }, { dx: -1, dy: 1, f: 1 / 4 }, { dx: 0, dy: 1, f: 1 / 4 }\r\n    ]\r\n};\r\n\r\nfunction findClosestColor(pixel: RGB, palette: RGB[], paletteLab: LAB[]): RGB {\r\n    // Use CIELAB for better perceptual matching\r\n    const pixelLab = rgbToLab(pixel);\r\n    let minDist = Infinity;\r\n    let closest = palette[0];\r\n\r\n    for (let i = 0; i < palette.length; i++) {\r\n        const dist = getDeltaE(pixelLab, paletteLab[i]);\r\n        if (dist < minDist) {\r\n            minDist = dist;\r\n            closest = palette[i];\r\n        }\r\n    }\r\n    return closest;\r\n}\r\n\r\nfunction applyDithering(imageData: ImageData, paletteHex: string[], algorithm: string, strength: number) {\r\n    const pixels = imageData.data;\r\n    const width = imageData.width;\r\n    const height = imageData.height;\r\n    \r\n    const paletteRGB = paletteHex.map(hexToRgb);\r\n    const paletteLab = paletteRGB.map(rgbToLab);\r\n\r\n    const strengthFactor = strength / 100;\r\n\r\n    if (algorithm in ditherMatrices) {\r\n        // Ordered Dithering\r\n        const dither = ditherMatrices[algorithm];\r\n        const matrix = dither.matrix;\r\n        const mSize = dither.size;\r\n        const mDiv = dither.divisor;\r\n        const BASE_DITHER_STRENGTH = 64; // Increased base strength\r\n\r\n        for (let y = 0; y < height; y++) {\r\n            for (let x = 0; x < width; x++) {\r\n                const index = (y * width + x) * 4;\r\n                if (pixels[index + 3] < 128) { pixels[index + 3] = 0; continue; }\r\n\r\n                const mX = x % mSize;\r\n                const mY = y % mSize;\r\n                const threshold = matrix[mY][mX];\r\n                \r\n                // Nudge calculation\r\n                const nudge = (threshold / mDiv - 0.5) * BASE_DITHER_STRENGTH * strengthFactor;\r\n\r\n                const oldColor = {\r\n                    r: Math.max(0, Math.min(255, pixels[index] + nudge)),\r\n                    g: Math.max(0, Math.min(255, pixels[index + 1] + nudge)),\r\n                    b: Math.max(0, Math.min(255, pixels[index + 2] + nudge))\r\n                };\r\n\r\n                const newColor = findClosestColor(oldColor, paletteRGB, paletteLab);\r\n\r\n                pixels[index] = newColor.r;\r\n                pixels[index + 1] = newColor.g;\r\n                pixels[index + 2] = newColor.b;\r\n                pixels[index + 3] = 255;\r\n            }\r\n        }\r\n    } else {\r\n        // Error Diffusion\r\n        const pixelDataFloat = new Float32Array(pixels);\r\n        const kernel = errorKernels[algorithm];\r\n\r\n        for (let y = 0; y < height; y++) {\r\n            for (let x = 0; x < width; x++) {\r\n                const index = (y * width + x) * 4;\r\n                if (pixelDataFloat[index + 3] < 128) { pixels[index + 3] = 0; continue; }\r\n\r\n                const oldColor = { \r\n                    r: pixelDataFloat[index], \r\n                    g: pixelDataFloat[index + 1], \r\n                    b: pixelDataFloat[index + 2] \r\n                };\r\n                \r\n                const newColor = findClosestColor(oldColor, paletteRGB, paletteLab);\r\n\r\n                pixels[index] = newColor.r;\r\n                pixels[index + 1] = newColor.g;\r\n                pixels[index + 2] = newColor.b;\r\n                pixels[index + 3] = 255;\r\n\r\n                if (algorithm === 'none' || !kernel) continue;\r\n\r\n                const err = { \r\n                    r: (oldColor.r - newColor.r) * strengthFactor, \r\n                    g: (oldColor.g - newColor.g) * strengthFactor, \r\n                    b: (oldColor.b - newColor.b) * strengthFactor \r\n                };\r\n\r\n                for (const k of kernel) {\r\n                    const nX = x + k.dx, nY = y + k.dy;\r\n                    if (nX >= 0 && nX < width && nY >= 0 && nY < height) {\r\n                        const i2 = (nY * width + nX) * 4;\r\n                        if (pixelDataFloat[i2 + 3] < 128) continue;\r\n                        pixelDataFloat[i2] += err.r * k.f;\r\n                        pixelDataFloat[i2 + 1] += err.g * k.f;\r\n                        pixelDataFloat[i2 + 2] += err.b * k.f;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n// --- K-Means Clustering ---\r\n\r\nfunction kmeans(data: number[][], k: number, maxIterations = 20): Promise<{ centroids: number[][], assignments: number[] }> {\r\n    return new Promise(resolve => {\r\n        if (k > data.length) {\r\n            k = data.length;\r\n        }\r\n        if (k === 0) {\r\n            resolve({ centroids: [], assignments: [] });\r\n            return;\r\n        }\r\n\r\n        let centroids: number[][] = [];\r\n        const tempData = [...data];\r\n        for (let i = 0; i < k; i++) {\r\n            const index = Math.floor(Math.random() * tempData.length);\r\n            centroids.push(tempData.splice(index, 1)[0]);\r\n        }\r\n\r\n        let assignments = new Array(data.length);\r\n\r\n        for (let iter = 0; iter < maxIterations; iter++) {\r\n            for (let i = 0; i < data.length; i++) {\r\n                let min_dist = Infinity;\r\n                let best_centroid = -1;\r\n                for (let j = 0; j < k; j++) {\r\n                    const dist = (data[i][0] - centroids[j][0]) ** 2 + (data[i][1] - centroids[j][1]) ** 2 + (data[i][2] - centroids[j][2]) ** 2;\r\n                    if (dist < min_dist) { min_dist = dist; best_centroid = j; }\r\n                }\r\n                assignments[i] = best_centroid;\r\n            }\r\n\r\n            const newCentroids = Array.from({ length: k }, () => [0, 0, 0]);\r\n            const counts = new Array(k).fill(0);\r\n            for (let i = 0; i < data.length; i++) {\r\n                const cIndex = assignments[i];\r\n                newCentroids[cIndex][0] += data[i][0];\r\n                newCentroids[cIndex][1] += data[i][1];\r\n                newCentroids[cIndex][2] += data[i][2];\r\n                counts[cIndex]++;\r\n            }\r\n\r\n            for (let i = 0; i < k; i++) {\r\n                if (counts[i] > 0) {\r\n                    newCentroids[i][0] /= counts[i];\r\n                    newCentroids[i][1] /= counts[i];\r\n                    newCentroids[i][2] /= counts[i];\r\n                } else {\r\n                    newCentroids[i] = data[Math.floor(Math.random() * data.length)];\r\n                }\r\n            }\r\n\r\n            let changed = false;\r\n            for (let i = 0; i < k; i++) {\r\n                if (centroids[i][0] !== newCentroids[i][0] || centroids[i][1] !== newCentroids[i][1] || centroids[i][2] !== newCentroids[i][2]) {\r\n                    changed = true; break;\r\n                }\r\n            }\r\n            centroids = newCentroids;\r\n            if (!changed) break;\r\n        }\r\n\r\n        resolve({ centroids, assignments });\r\n    });\r\n}\r\n\r\nfunction rgbToHex(rgb: { r: number; g: number; b: number }): string {\r\n    const toHex = (c: number) => {\r\n        const hex = Math.round(c).toString(16);\r\n        return hex.length === 1 ? '0' + hex : hex;\r\n    };\r\n    return `#${toHex(rgb.r)}${toHex(rgb.g)}${toHex(rgb.b)}`.toUpperCase();\r\n}\r\n\r\nasync function suggestMissingColors(\r\n    imageData: ImageData, \r\n    paletteHex: string[], \r\n    numToSuggest: number\r\n): Promise<string[]> {\r\n    if (paletteHex.length === 0) return [];\r\n    \r\n    const paletteRGB = paletteHex.map(hexToRgb);\r\n    const paletteLAB = paletteRGB.map(rgbToLab);\r\n    \r\n    // Extract non-transparent pixels with sampling for performance\r\n    const pixels = imageData.data;\r\n    const pixelArray: number[][] = [];\r\n    \r\n    // Calculate step size to limit total pixels to approx 4096 (64x64) for performance\r\n    const totalPixels = pixels.length / 4;\r\n    const maxPixels = 4096;\r\n    const step = Math.ceil(totalPixels / maxPixels) * 4;\r\n\r\n    for (let i = 0; i < pixels.length; i += step) {\r\n        if (pixels[i + 3] > 128) {\r\n            pixelArray.push([pixels[i], pixels[i + 1], pixels[i + 2]]);\r\n        }\r\n    }\r\n    \r\n    if (pixelArray.length === 0) return [];\r\n    \r\n    // Run K-Means to find 128 dominant clusters\r\n    // Reduce k if we have fewer pixels than k\r\n    const k = Math.min(128, pixelArray.length);\r\n    const kmeansResult = await kmeans(pixelArray, k);\r\n    const centroids = kmeansResult.centroids;\r\n    const assignments = kmeansResult.assignments;\r\n    \r\n    // Count pixels per cluster\r\n    const pixelCounts = new Array(centroids.length).fill(0);\r\n    for (const assignment of assignments) {\r\n        pixelCounts[assignment]++;\r\n    }\r\n    \r\n    // Calculate error for each centroid\r\n    const centroidErrors: { hex: string; error: number; count: number; totalError: number }[] = [];\r\n    \r\n    for (let i = 0; i < centroids.length; i++) {\r\n        const c = centroids[i];\r\n        const count = pixelCounts[i];\r\n        \r\n        if (count === 0) continue;\r\n        \r\n        const centroidColorRGB = { r: Math.round(c[0]), g: Math.round(c[1]), b: Math.round(c[2]) };\r\n        const centroidColorLAB = rgbToLab(centroidColorRGB);\r\n        \r\n        // Find closest color in palette using CIELAB\r\n        let minDeltaE = Infinity;\r\n        for (const colorLAB of paletteLAB) {\r\n            const dist = getDeltaE(centroidColorLAB, colorLAB);\r\n            if (dist < minDeltaE) {\r\n                minDeltaE = dist;\r\n            }\r\n        }\r\n        \r\n        const totalError = minDeltaE * count;\r\n        \r\n        centroidErrors.push({\r\n            hex: rgbToHex(centroidColorRGB),\r\n            error: minDeltaE,\r\n            count: count,\r\n            totalError: totalError\r\n        });\r\n    }\r\n    \r\n    // Sort by total error (descending) and return top N\r\n    centroidErrors.sort((a, b) => b.totalError - a.totalError);\r\n    return centroidErrors.slice(0, numToSuggest).map(c => c.hex);\r\n}\r\n\r\nfunction applyColorModifiers(imageData: ImageData, brightness: number, contrast: number, saturation: number): ImageData {\r\n  const data = imageData.data;\r\n  const width = imageData.width;\r\n  const height = imageData.height;\r\n  const newImageData = new ImageData(new Uint8ClampedArray(data), width, height);\r\n  const d = newImageData.data;\r\n\r\n  // Pre-calculate contrast factor\r\n  // Contrast is usually -100 to 100.\r\n  // Formula: factor = (259 * (contrast + 255)) / (255 * (259 - contrast))\r\n  const contrastFactor = (259 * (contrast + 255)) / (255 * (259 - contrast));\r\n\r\n  for (let i = 0; i < d.length; i += 4) {\r\n    let r = d[i];\r\n    let g = d[i+1];\r\n    let b = d[i+2];\r\n\r\n    // 1. Brightness\r\n    if (brightness !== 0) {\r\n        r += brightness;\r\n        g += brightness;\r\n        b += brightness;\r\n    }\r\n\r\n    // 2. Contrast\r\n    if (contrast !== 0) {\r\n        r = contrastFactor * (r - 128) + 128;\r\n        g = contrastFactor * (g - 128) + 128;\r\n        b = contrastFactor * (b - 128) + 128;\r\n    }\r\n\r\n    // 3. Saturation\r\n    if (saturation !== 0) {\r\n        const gray = 0.2989 * r + 0.5870 * g + 0.1140 * b;\r\n        const satMult = 1 + (saturation / 100);\r\n        \r\n        r = gray + (r - gray) * satMult;\r\n        g = gray + (g - gray) * satMult;\r\n        b = gray + (b - gray) * satMult;\r\n    }\r\n\r\n    d[i] = r;\r\n    d[i+1] = g;\r\n    d[i+2] = b;\r\n  }\r\n\r\n  return newImageData;\r\n}\r\n\r\n// --- Main Handler ---\r\n\r\nself.onmessage = async (e: MessageEvent) => {\r\n    const { type, imageData, settings } = e.data;\r\n    \r\n    if (type === 'suggest') {\r\n        // Handle suggestion request\r\n        try {\r\n            const { palette, numSuggestions } = settings;\r\n            const suggestions = await suggestMissingColors(imageData, palette, numSuggestions || 5);\r\n            self.postMessage({ type: 'suggestions', suggestions });\r\n        } catch (error: any) {\r\n            self.postMessage({ type: 'error', message: error.message });\r\n        }\r\n        return;\r\n    }\r\n    \r\n    // Regular processing\r\n    const { targetWidth, targetHeight, ditherMethod, ditherStrength, palette, resamplingMethod, useKmeans, kmeansColors, brightness, contrast, saturation } = settings;\r\n\r\n    try {\r\n        // 0. Apply Color Modifiers\r\n        let processedImageData = imageData;\r\n        if ((brightness && brightness !== 0) || (contrast && contrast !== 0) || (saturation && saturation !== 0)) {\r\n            processedImageData = applyColorModifiers(imageData, brightness || 0, contrast || 0, saturation || 0);\r\n        }\r\n\r\n        // 1. Resize\r\n        let resizedImageData: ImageData;\r\n        if (resamplingMethod === 'lanczos') {\r\n            resizedImageData = resampleLanczos(processedImageData, targetWidth, targetHeight);\r\n        } else if (resamplingMethod === 'bilinear') {\r\n            resizedImageData = resampleBilinear(processedImageData, targetWidth, targetHeight);\r\n        } else {\r\n            resizedImageData = resampleNearest(processedImageData, targetWidth, targetHeight);\r\n        }\r\n\r\n        // 2. (Optional) K-Means color clustering\r\n        if (useKmeans && kmeansColors > 0) {\r\n            const pixels = resizedImageData.data;\r\n            const pixelArray: number[][] = [];\r\n            for (let i = 0; i < pixels.length; i += 4) {\r\n                if (pixels[i + 3] > 128) {\r\n                    pixelArray.push([pixels[i], pixels[i + 1], pixels[i + 2]]);\r\n                }\r\n            }\r\n\r\n            if (pixelArray.length > 0) {\r\n                const kmeansResult = await kmeans(pixelArray, Math.min(kmeansColors, pixelArray.length));\r\n                const paletteRGB = kmeansResult.centroids.map(c => ({\r\n                    r: Math.round(c[0]),\r\n                    g: Math.round(c[1]),\r\n                    b: Math.round(c[2])\r\n                }));\r\n                const paletteLab = paletteRGB.map(rgbToLab);\r\n\r\n                for (let i = 0; i < pixels.length; i += 4) {\r\n                    if (pixels[i + 3] > 128) {\r\n                        const pixelColor = { r: pixels[i], g: pixels[i + 1], b: pixels[i + 2] };\r\n                        const closestColor = findClosestColor(pixelColor, paletteRGB, paletteLab);\r\n                        pixels[i] = closestColor.r;\r\n                        pixels[i + 1] = closestColor.g;\r\n                        pixels[i + 2] = closestColor.b;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        // 3. Dither\r\n        if (palette && palette.length > 0) {\r\n            applyDithering(resizedImageData, palette, ditherMethod, ditherStrength);\r\n        }\r\n\r\n        self.postMessage({ type: 'success', imageData: resizedImageData });\r\n\r\n    } catch (error: any) {\r\n        self.postMessage({ type: 'error', message: error.message });\r\n    }\r\n};\r\n"],"names":["hexToRgb","hex","result","rgbToXyz","c","r","g","b","xyzToLab","x","y","z","rgbToLab","getDeltaE","labA","labB","deltaL","deltaA","deltaB","resampleNearest","srcData","width","height","src","dest","destData","xRatio","yRatio","srcX","srcIdx","destIdx","resampleBilinear","srcY","x1","y1","x2","y2","dx","dy","v1","v2","v3","v4","top","bottom","value","resampleLanczos","imageData","srcWidth","srcHeight","destImageData","sinc","piX","lanczosKernel","a","ratioX","ratioY","sy","sx","a_val","totalWeight","startX","endX","startY","endY","weight","srcIndex","destIndex","ditherMatrices","errorKernels","findClosestColor","pixel","palette","paletteLab","pixelLab","minDist","closest","i","dist","applyDithering","paletteHex","algorithm","strength","pixels","paletteRGB","strengthFactor","dither","matrix","mSize","mDiv","BASE_DITHER_STRENGTH","index","mX","mY","nudge","oldColor","newColor","pixelDataFloat","kernel","err","k","nX","nY","i2","kmeans","data","maxIterations","resolve","centroids","tempData","assignments","iter","min_dist","best_centroid","j","newCentroids","counts","cIndex","changed","rgbToHex","rgb","toHex","suggestMissingColors","numToSuggest","paletteLAB","pixelArray","totalPixels","step","kmeansResult","pixelCounts","assignment","centroidErrors","count","centroidColorRGB","centroidColorLAB","minDeltaE","colorLAB","totalError","applyColorModifiers","brightness","contrast","saturation","newImageData","contrastFactor","gray","satMult","e","type","settings","numSuggestions","suggestions","error","targetWidth","targetHeight","ditherMethod","ditherStrength","resamplingMethod","useKmeans","kmeansColors","processedImageData","resizedImageData","pixelColor","closestColor"],"mappings":"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"}